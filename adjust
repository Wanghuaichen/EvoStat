:- use_module(library(time)).
:- use_module(newpid).
% The PID algorithm will call get_input/2 and set_output/3,
% but their implementation is PID independent, so they live here.

inTimeRange(X) :- minTime(Min), X >= Min, maxTime(Max), X =< Max.
minTime(300).
maxTime(20000).

initPID :-
	pid_controllers(Cs),
	launch_controllers(Cs).

get_input(Component, Level) :-
        get(Component, l, Level).

%
% set_output(Component, Old, New)
%
% For liquid level control, level readings
% result in incremental changes in valve open times.
% Level too high: -inflow  +outflow 
%       too low:  +inflow  -outflow
%
% The Autosampler controls drain valves for the other components
% Lagoon name ends with <digit>: v<digit> is that lagoon's drain
% Otherwise it must be the Cellstat's drain 'v0'
%

set_output(Obj, Old, New) :-
     Inflow is integer(5*(New-Old)),
     adjust(Obj, Inflow).

adjust(Obj, Inflow) :-
     component_index(Obj,N),  % Index determines valve
     index_valve(N,InValve,OutValve),
     adjust_valve(Obj,InValve,Inflow), 
     component(_,sampler,SObj),
     Outflow is -Inflow,
     adjust_valve(SObj,OutValve,Outflow).


adjust_valve(Obj, Valve, Amt) :-
      get(Obj, Valve, Setting),
      New is Setting + Amt,
      ( inTimeRange(New)
       -> send(Obj, Valve, New),
      	  assert(changed(Obj,Valve,Amt))
       ;  plog('VALVE LIMIT'(Valve,Setting))
      ).
