#!/usr/bin/xpce

:- pce_begin_class(dialin, dialog, "Conversation").

initialise(Self, Label:[name], Socket:[int]) :->
	"Have a short conversation over Bluetooth"::
        send_super(Self, initialise(Label)),
	send(Self?frame, icon, bitmap('./evo.xpm')),     % Our logo
        new(Diatxt, text_buffer('')),    % Text object in an
        new(Diaed,  editor(Diatxt)),    % Emacs-like window
	send(Self,append(Diaed)),
        get(Diaed, area, Area),                         % Resize it 
	send(Area, set( width := 300, height := 200) ),
	new(Code, message(Self, converse, Label, Socket, Diatxt?contents, Diaed)),
        send(Self, append, button(send_command, Code)),
	send_super(Self, open, point(600,200)).         % In the right place 

converse(_, Who, Socket, Contents, Editor) :->
	"Send command to Bluetooth Socket and show Reply"::
	get(Contents, value, Cmd),
	(Socket = -1
	 -> concat_atom(['no_connection(',Who,',''',Socket,''').'], Message)
	 ; ( bt_converse(Socket, Cmd, Message)
	    -> true
	    ; concat_atom(['failed(',Who,',"',Cmd,'").'],Message)
	   )
	),
	send(Editor?text_buffer, append, Message).

:- pce_end_class.

